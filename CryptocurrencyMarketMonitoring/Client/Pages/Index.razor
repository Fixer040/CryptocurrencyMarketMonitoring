@page "/"
@using CryptocurrencyMarketMonitoring.Shared
@using System.Collections.ObjectModel
@using Syncfusion.Blazor.Grids
@using System.ComponentModel
@using System.Linq;
@using Microsoft.AspNetCore.SignalR.Client
@using System.Collections.Generic;
@using Microsoft.Extensions.DependencyInjection;
@using CryptocurrencyMarketMonitoring.Client.Services;
@implements IAsyncDisposable



@inject NavigationManager NavigationManager



@inject IHttpService Http


<div class=" px-4 text-center justify-content-center w-75 m-auto">
    <h1 class="text-capitalize text-dark">Cryptocurrency prices today</h1>

    <SfGrid @ref="Grid" DataSource="@Cryptocurrencies" AllowSorting="true" AllowPaging="true">
        <GridPageSettings PageSize="100"></GridPageSettings>
        <GridSortSettings>
            <GridSortColumns>
                <GridSortColumn Field="@nameof(OverviewDto.Ranking)" Direction="SortDirection.Ascending"></GridSortColumn>
            </GridSortColumns>
        </GridSortSettings>
        <GridColumns>
            <GridColumn Field="@nameof(OverviewDto.Ranking)" HeaderText="Ranking" TextAlign="TextAlign.Center" />
            <GridColumn HeaderText="" TextAlign="TextAlign.Center" Width="45" AllowSorting="false">
                <Template>
                    @{
                        var employee = (context as OverviewDto);
                        <div class="image">
                            <img width="30" height="30" src="@employee.IconSrc" />
                        </div>
                    }
                </Template>
            </GridColumn>
            <GridColumn Field="@nameof(OverviewDto.Name)" HeaderText="Name" TextAlign="TextAlign.Center" />
            <GridColumn Field="@nameof(OverviewDto.Ticker)" HeaderText="Symbol" TextAlign="TextAlign.Center">
                <Template>
                    @{
                        var ticker = ((OverviewDto)context).Ticker;
                        var link = $"/detail/{ticker}";
                        <div>
                            <NavLink href="@link">@ticker</NavLink>
                        </div>
                    }
                </Template>
            </GridColumn>
            <GridColumn Field="@nameof(OverviewDto.PriceUSD)" HeaderText="Price" TextAlign="TextAlign.Center">
                <Template>
                    @{
                        var dto = (OverviewDto)context;
                        var priceString = dto.PriceUSD < 1 ? dto.PriceUSD.ToString("$###,###,##0.0000") : dto.PriceUSD.ToString("$###,###,##0.00");

                        <div>@priceString</div>
                    }
                </Template>
            </GridColumn>
            <GridColumn Field="@nameof(OverviewDto.LastDayPercentageMovement)" HeaderText="24h" TextAlign="TextAlign.Center">
                <Template>
                    @{
                        <div class="@(((OverviewDto)context).LastDayPercentageMovement < 0 ? "text-danger" : "text-success")">
                            @(((OverviewDto)context).LastDayPercentageMovement.ToString("0.00%"))
                        </div>
                    }
                </Template>
            </GridColumn>
            <GridColumn Field="@nameof(OverviewDto.LastWeekPercentageMovement)" HeaderText="7d" TextAlign="TextAlign.Center">
                <Template>
                    @{
                        <div class="@(((OverviewDto)context).LastWeekPercentageMovement < 0 ? "text-danger" : "text-success")">
                            @(((OverviewDto)context).LastWeekPercentageMovement.ToString("0.00%"))
                        </div>
                    }
                </Template>
            </GridColumn>
            <GridColumn Field="@nameof(OverviewDto.VolumeUSD)" HeaderText="Volume" TextAlign="TextAlign.Center" Format="$###,###,###,###,###,###" />
            <GridColumn Field="@nameof(OverviewDto.MarketCapUSD)" HeaderText="Market cap" TextAlign="TextAlign.Center" Format="$###,###,###,###,###,###" />


        </GridColumns>
    </SfGrid>
</div>

<div class="mb-4"></div>


@code{
    public List<OverviewDto> Cryptocurrencies { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var cryptocurrencyList = await Http.Get<OverviewDto[]>("Overview/list");
        //var cryptocurrencyList = await Http.GetFromJsonAsync<CryptocurrencyOverviewDto[]>("CryptocurrencyOverview/list");

        Cryptocurrencies = new List<OverviewDto>(cryptocurrencyList);

        _updateHubConnection = new HubConnectionBuilder().AddJsonProtocol(options =>
        {
            options.PayloadSerializerOptions.PropertyNamingPolicy = null;
        }).WithUrl(NavigationManager.ToAbsoluteUri("/overview-update")).Build();

        _updateHubConnection.On<IEnumerable<OverviewUpdateDto>>("ReceiveUpdate", (updates) =>
        {
            DoGridUpdate(updates);
        });


        await _updateHubConnection.StartAsync();

        await base.OnInitializedAsync();
    }


    public async ValueTask DisposeAsync()
    {
        await _updateHubConnection.DisposeAsync();
    }

    private void DoGridUpdate(IEnumerable<OverviewUpdateDto> cryptocurrencyListUpdates)
    {
        foreach (var update in cryptocurrencyListUpdates)
        {
            switch (update.UpdateType)
            {
                case OverviewUpdateType.Create:
                    Cryptocurrencies.Add(update.Data);
                    break;
                case OverviewUpdateType.Delete:
                    Cryptocurrencies.Remove(Cryptocurrencies.FirstOrDefault(x => x.Name == update.Data.Name));
                    break;
                case OverviewUpdateType.Update:
                    UpdateCryptocurrencyOverviewData(Cryptocurrencies.FirstOrDefault(x => x.Name == update.Data.Name), update);
                    break;
                default:
                    continue;
            }
        }

        Grid.Refresh();
    }

    private void UpdateCryptocurrencyOverviewData(OverviewDto overview, OverviewUpdateDto update)
    {
        if (overview.Ranking != update.Data.Ranking)
            overview.Ranking = update.Data.Ranking;

        if (overview.LastDayPercentageMovement != update.Data.LastDayPercentageMovement)
            overview.LastDayPercentageMovement = update.Data.LastDayPercentageMovement;

        if (overview.LastWeekPercentageMovement != update.Data.LastWeekPercentageMovement)
            overview.LastWeekPercentageMovement = update.Data.LastWeekPercentageMovement;

        if (overview.MarketCapUSD != update.Data.MarketCapUSD)
            overview.MarketCapUSD = update.Data.MarketCapUSD;

        if (overview.PriceUSD != update.Data.PriceUSD)
            overview.PriceUSD = update.Data.PriceUSD;

        if (overview.VolumeUSD != update.Data.VolumeUSD)
            overview.VolumeUSD = update.Data.VolumeUSD;
    }

    private HubConnection _updateHubConnection;
    public SfGrid<OverviewDto> Grid;
}
